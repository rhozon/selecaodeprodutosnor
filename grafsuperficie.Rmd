---
title: "Gráfico de superfície 3d interativo para regressão linear múltipla"
author: "Rodrigo H. Ozon"
date: "21/09/2020"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


***

&nbsp;

#### Resumo


<small>Este tutorial demonstra como gerar um gráfico de superfície de regressão linear múltipla interativa utilizando o R. Aqui neste exemplo peguei os dados do curso **"Introdução à Econometria utilizando o Excel"** com o intuito de estimular os estudantes a interagirem com os dados que analisamos durante o aprendizado.

**Palavras-chave**: Gráfico 3D de regressão múltipla, interação, econometria, R</small>


***

![](https://github.com/rhozon/Introdu-o-Econometria-com-Excel/blob/master/introeconometriacapa.png?raw=true){ width=80% }

***




# Preliminares (dados do exemplo)

Como vimos em nossas vídeo aulas de regressão linear múltipla, o gráfico de dispersão entre somente duas variáveis não atende quando precisamos inserir mais variáveis explicativas $X$ em nosso modelo.


<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Dadas as estimativas de MQO para o modelo de regressão linear múltipla, vamos supor que precisássemos estimar o consumo de óleo para calefação em residências no inverno canadense. Vamos começar com um conjunto de dados obtido por uma amostra de 15 domicílios gerada por um projetista responsável por esta análise.

Embora pudéssemos considerar muitas variáveis, por motivo de simplificação devemos avaliar somente duas variáveis explicativas nesse caso:

+ A temperatura atmosférica média diária (em graus Fahrenheit) durante o mês da coleta ($X_{1}$);
+ Quantidade de isolamento térmico da residência medida em polegadas ($X_{2}$)


Como um gráfico tridimensional descreve com maior detalhe o comportamento da variável $Y$ (consumo de óleo) contra as outras duas explicativas (temperatura e isolamento) temos uma primeira inspeção visual das pistas para causa e efeito:
</p>


Se você consultar o e-book, na página 58, verá esse gráfico:

![](https://github.com/rhozon/Introdu-o-Econometria-com-Excel/blob/master/superficieregressao.png?raw=true){ width=50% }

Assim como no e-book, a imagem reproduzida acima, não nos permite interagir com o gráfico.  Aqui, neste breve tutorial, reproduziremos utilizando o R o passo a passo de como criamos esse gráfico de forma interativa e plenamente capaz ilustrar as relações entre essas três variáveis.

# O que é o R ?

R é um software livre para análise de dados. Foi desenvolvido em em 1996, com os professores de estatística Ross Ihaka e Robert Gentleman, da Universidade de Auckland que criaram uma nova linguagem computacional, similar a linguagem S desenvolvida por John Chambers.

Já outros o definem assim:

<p style="font-family: times, serif; font-size:11pt; font-style:italic">
R é uma linguagem de programação estatística e gráfica que vem se especializando na manipulação, análise e visualização de dados, sendo atualmente considerada uma das melhores ferramentas para essa finalidade. A linguagem ainda possui como diferencial a facilidade no aprendizado, mesmo para aqueles que nunca tiveram contato anterior com programação. ([Didática Tech](https://didatica.tech/a-linguagem-r/))
</p>

# Porque utilizar o R ?

+ O R é um software gratuito com código aberto com uma linguagem acessível;

+ a sua expansão de uso é exponencial entre pesquisadores, engenheiros e estatísticos;

+ ele se reinventa constantemente através de novas aplicações (aproximadamente 15.000 pacotes);

+ é totalmente flexível, permitindo desenvolver facilmente funções e pacotes para facilitar o trabalho;

+ possui um enorme capacidade gráfica e interage com apps de BI (Microsoft Power BI, p. ex.)

+ Está disponível para diferentes plataformas: Windows, Linux e Mac


Segundo o site [datascienceacademy:](http://datascienceacademy.com.br/blog/linguagem-r-por-que-e-hora-de-aprender/)

<p style="font-family: times, serif; font-size:9pt; font-style:italic">
Uma imagem vale mais que 1000 palavras, certo? Mas apenas 10 palavras são necessárias para criar incríveis gráficos e imagens usando a linguagem R. A evolução e amadurecimento do R, tem levado grandes empresas como Oracle e Microsoft, a investirem seus bilionários recursos em pesquisa e desenvolvimento para aprimorar suas soluções analíticas utilizando o R como base. A linguagem R vem se tornando ainda o principal “idioma” de Cientistas e Analistas de Dados e está liderando a revolução proporcionada pelo Big Data Analytics.
</p>

Você pode baixar o R e o RStudio no site [http://cran.r-project.org/](http://cran.r-project.org/) e o RStudio em [https://rstudio.com/](https://rstudio.com/).

Caso você queira trabalhar com o R na nuvem, recomendo que você crie uma conta no RStudio Cloud em [https://rstudio.com/products/cloud/](https://rstudio.com/products/cloud/)


# Carregando os dados de consumo de óleo para calefação

Carrego os dados direto do nosso repositório de datasets upado no GitHub:

```{r message=FALSE}
# Preprocessamento dos dados ---------------------------------------------------------

oleo<-read.csv(file="https://raw.githubusercontent.com/rhozon/Introdu-o-Econometria-com-Excel/master/proR.csv",head=TRUE,sep=";")

str(oleo)
```

## Rodando as regressões para prever o consumo de óleo para calefação

Vamos rodar os dois modelos de regressão linear múltipla com e sem a _dummie_ de estilo das casas: (Lembre-se que _"partindo de uma amostra de 15 casas, nas quais as casas de números 1, 4, 6, 7, 8, 10 e 12 são em estilo colonial"_(...))

```{r message=FALSE}
regr1 <- lm(consumooleo ~ qtdisolamento, data = oleo)
regr2 <- lm(consumooleo ~ temperatura, data = oleo)
regr3 <- lm(consumooleo ~ qtdisolamento+temperatura, data = oleo)
regr4 <- lm(consumooleo ~ qtdisolamento+temperatura+estilo, data = oleo)

```

Vamos ver os resultados mais completos das regressões:

&nbsp;

```{r echo=FALSE, results='asis', message = FALSE}
#http://people.virginia.edu/~jcf2d/exercises/getting_started_with_stargazer.html
library(stargazer)
stargazer(regr1, regr2, regr3, regr4, type="html", 
          column.labels = c("regr1", "regr2", "regr3", "regr4"), 
          intercept.bottom = FALSE, 
          single.row=FALSE,     
          notes.append = FALSE, 
          header=FALSE) 
```

&nbsp;

Agora vamos ver num gráfico da regressão ajustada (como se fosse no Excel), verificando 


```{r message=FALSE , fig.width=3, fig.height=3}
library(ggplot2)
library(lattice)
library(pdp)
require(ggiraph)
require(ggiraphExtra)
require(plyr)

a<-ggPredict(regr1,se=TRUE,interactive=TRUE)

b<-ggPredict(regr2,se=TRUE,interactive=TRUE)

c<-ggPredict(regr3,se=TRUE,interactive=TRUE)

d<-ggPredict(regr4,se=TRUE,interactive=TRUE)

a#Resultado da Regressao linear simples de Quantidade de Isolamento em Consumo de Oleo

b#Resultado da Regressao de Temperatura em Consumo de Oleo

c#Resultado da Regressao da Qtd Isolamento e Temperatura no Consumo de Oleo

d#Resultado da Regressao c com a dummie de estilo

```

Note que para os gráficos c, temos uma reta de regressão para cada nível de temperatura (em graus Fahrenheit) e no d, temos uma reta de regressão para cada estilo conforme temperatura. Perceba que os valores das inclinações não mudam, mas os valores dos interceptos sim (por quê ?).

Mas ainda assim, está um pouco difícil a nossa interpretação dessas relações entre as variáveis de nosso modelo de previsão de consumo de óleo para calefação...


```{r message=FALSE}
library(plotly)
plot_ly(data = oleo, z = ~ consumooleo, x = ~ temperatura, y = ~ qtdisolamento, color=~estilo, colors = c('#0C4B8E' ,'#BF382A'),opacity = 0.5) %>%
  add_markers( marker = list(size = 5)) 
```


```{r message=FALSE}
library(plotly)
# draw 3D scatterplot
p <- plot_ly(data = oleo, z = ~ consumooleo, x = ~ temperatura, y = ~ qtdisolamento, opacity = 0.6) %>%
  add_markers() 
p
```


# Gerando o gráfico 3D no R (passo a passo)

Para criarmos o gráfico interativo aqui no HTML, utilizo o RMarkdown para com os seguintes pacotes:


```{r message=FALSE}
library(tidyverse)
library(plotly)
library(moderndive)
```

Defino os eixos tridimensionais nas coordenadas $x,y,z$ para o gráfico:

```{r message=FALSE}
# Definicao dos pontos das coordenadas --------------------------------------------
# Obtenho os pontos das coordenadas para o 3D scatterplot
x_valores <- oleo$temperatura %>% 
  round(3)
y_valores <- oleo$qtdisolamento %>% 
  round(3)
z_valores <- oleo$consumooleo %>% 
  round(3)
```

Construo a definição da malha que cubrirá os eixos $x$ e $y$ do plano:

```{r message=FALSE}
# Defino o plano da regressao -------------------------------------------------
# Construcao da malha dos elementos x e y
x_grid <- seq(from = min(x_valores), to = max(x_valores), length = 50)
y_grid <- seq(from = min(y_valores), to = max(y_valores), length = 50)
```

Então construo o eixo $z$, obtendo os valores da regressão linear múltipla estimada e seus coeficientes:


```{r message=FALSE}
# Construcao da malha do eixo z obtendo
# 1) parametros alfa e beta estimados
# 2) valores ajustados do produto externo de x_grid e y_grid
# 3) extracao de z_grid (essa matriz precisa de dimensoes especificas)

beta_chapeu <- oleo %>% 
  lm(consumooleo ~ qtdisolamento + temperatura, data = .) %>% 
  coef()

valores_ajustados <- crossing(y_grid, x_grid) %>% 
  mutate(z_grid = beta_chapeu[1] + beta_chapeu[2]*x_grid + beta_chapeu[3]*y_grid)

z_grid <- valores_ajustados %>% 
  pull(z_grid) %>%
  matrix(nrow = length(x_grid)) %>%
  t()
```

Declaro os elementos de texto para cada ponto no plano:

```{r message=FALSE}

text_grid <- valores_ajustados %>% 
  pull(z_grid) %>%
  round(3) %>% 
  as.character() %>% 
  paste("Consumo de Oleo ", ., sep = "") %>% 
  matrix(nrow = length(x_grid)) %>%
  t()
```

Utilizo a função plot_ly do R para gerar a visualização:

```{r message=FALSE}

plot_ly() %>%
  # 3D scatterplot:
  add_markers(
    x = x_valores,
    y = y_valores,
    z = z_valores,
    marker = list(size = 5),
    hoverinfo = 'text',
    text = ~paste(
      "Quantidade de Isolamento Termico ", z_valores, "<br>",
      "Consumo de Oleo para Calefacao ", y_valores, "<br>",
      "Temperatura atmosferica ", x_valores 
    )
  ) %>%
  # Plano da regressao:
  add_surface(
    x = x_grid,
    y = y_grid,
    z = z_grid,
    hoverinfo = 'text',
    text = text_grid
  ) %>%
  # Nomes dos eixos e titulo:
  layout(
    title = "Superficie de Regressao 3d interativa",
    scene = list(
      zaxis = list(title = "y: consumooleo"),
      yaxis = list(title = "x2: temperatura"),
      xaxis = list(title = "x1: qtdisolamento")
    )
  )
```


# Mas e a _dummie_ de estilo colonial ? Como insiro ela no gráfico interativo ?


Vamos utilizar um método mais simples para gerar esse gráfico. Inicialmente repassaremos a construção do gráfico acima (num outro estilo) em seguida iremos inserir uma outra superfície para representar a inclusão da _dummie_ de estilo. Comecemos com a regressão linear múltipla de nosso modelo:

```{r message=FALSE}
mod <- lm(consumooleo ~ temperatura + qtdisolamento, data = oleo)
mod
```


Primeiro, crie um _range_ dos pares de valores possíveis das variáveis explicativas. Esse _range_ deve estar acima do intervalo real dos dados presentes em cada variável. Fizemos isso para você e armazenamos o resultado como um quadro de dados chamado range.

```{r}
range <- expand.grid(temperatura = seq(5, 90, by = 5), 
                     qtdisolamento = seq(2, 15, by = 3))
```

Agora vamos ver como as explicativas se comportam no gráfico frente a dependente:

```{r message=FALSE}
padrao_explicativas <- ggplot(data = oleo, 
                     aes(x = qtdisolamento, y = temperatura)) + 
                     geom_point(aes(color = consumooleo)) + 
                     theme_bw()

ggplotly(padrao_explicativas)
```

Agora use a função augment() para criar um data.frame que contém os valores que o modelo produz para cada linha da seu range.

```{r}
estimativa <- broom::augment(mod, newdata = range)
```

Use geom_tile para ilustrar esses valores previstos no gráfico padrao_explicativas. Use aesthetic para preenchimento e defina alpha = 0.5.


```{r}
grafpreenchido<-padrao_explicativas + 
            geom_tile(data = estimativa, aes(fill = .fitted), alpha = 0.5)

ggplotly(grafpreenchido)
```

.fitted é o mesmo que estimado ou ajustado para onde você posicionar seu mouse no gráfico.


Agora, para definirmos um plano para a superfície da regressão, precisamos rever nosso modelo regredido (sem a dummie):

```{r}
summary(mod)$coef
```


Usaremos add_surface() para desenhar um plano através da nuvem de pontos definindo z = ~ plano. [Veja a Wikipedia para a definição de um produto externo de matrizes](https://en.wikipedia.org/wiki/Outer_product). A seguir, usaremos a função outer() para calcular os valores do plano.

```{r}
range_x <- seq(5, 90, length = 70)#representa <min temperatura e >max temperatura
range_y <- seq(2, 15, length = 70)#representa <min qtdisolamento e >max qtdisolamento

plano <- outer(range_x, range_y, function(a, b){summary(mod)$coef[1,1] + 
         summary(mod)$coef[2,1]*a + summary(mod)$coef[3,1]*b})
```

Lembrando que esses valores para as coordenadas $x$ e $y$ acima descritos são as mesmas definidas em nosso range anteriormente. É interessante que saibamos que os valores desses ranges precisam cobrir abaixo e acima dos limites inferiores dos valores mínimos e máximos para as variáveis contidas neles.

Após delinearmos os valores do plano, podemos agora adicionar os valores regredidos de nosso modelo sem a _dummie_ como uma reta superfície:

```{r}
p %>%
  add_surface(x = ~range_x, y = ~range_y, z = ~plano, showscale = FALSE)
```

Agora que temos dois planos diferentes de superfície, inserimos o modelo completo com seus coeficientes:

```{r}
modI <- lm(consumooleo ~ temperatura + qtdisolamento + estilo, data = oleo)
summary(modI)$coef
```

Então finalmente obtemos os valores dos planos (superfícies):

```{r}
plano0<-outer(range_x, range_y, function(a, b){summary(mod)$coef[1,1] + 
               summary(mod)$coef[2,1]*a + summary(mod)$coef[3,1]*b})

plano1<-outer(range_x, range_y, function(a, b){summary(mod)$coef[1,1] + 
               summary(mod)$coef[2,1]*a + summary(mod)$coef[3,1]*b +                                 summary(modI)$coef[4,1]})

```

Usando finalmente a função plot_ly para desenhar o gráfico de dispersão 3D para consumooleo como uma função de temperatura, qtdisolamento e estilo mapeando a variável $z$ para a resposta e as variáveis $x$ e $y$ para as variáveis explicativas. A quantidade de isolamento deve estar no eixo x e a temperatura deve estar no eixo y. Use a cor para representar o estilo.


```{r}
p <- plot_ly(data = oleo, z = ~consumooleo, x = ~qtdisolamento, y = ~temperatura, opacity = 0.6) %>%
  add_markers(color = ~estilo) 
p
```


Então desenhamos os dois planos:

```{r message=FALSE}
p %>%
  add_surface(x = ~range_x, y = ~range_y, z = ~plano0, showscale = FALSE) %>%
  add_surface(x = ~range_x, y = ~range_y, z = ~plano1, showscale = FALSE)
```

Vamos comparar os valores das regressões sem e com a dummie de estilo:


```{r echo=FALSE, results='asis', message = FALSE}
#http://people.virginia.edu/~jcf2d/exercises/getting_started_with_stargazer.html
library(stargazer)
stargazer(mod, modI, type="html", 
          column.labels = c("mod", "modI"), 
          intercept.bottom = FALSE, 
          single.row=FALSE,     
          notes.append = FALSE, 
          header=FALSE) 
```

&nbsp;

## Exercício proposto

<p style="font-family: times, serif; font-size:11pt; font-style:italic">
*Para você que já é usuário do R, fica como exercício fazer esse gráfico com a variável estilo como factor (use mutate e as.factor) para transformá-la.
</p>


### Solução

```{r message=FALSE}
oleo<-oleo%>%
  mutate(estilo=as.factor(estilo))

str(oleo)

```

Nova regressão:

```{r}
modII<-lm(consumooleo ~ temperatura + qtdisolamento + estilo, data = oleo)
summary(modII)$coef
```



Agora com os novos valores regredidos temos:

```{r}
range_x <- seq(5, 90, length = 70)#representa <min temperatura e >max temperatura
range_y <- seq(2, 15, length = 70)#representa <min qtdisolamento e >max qtdisolamento

planofator <- outer(range_x, range_y, function(a, b){summary(modII)$coef[1,1] + 
    summary(modII)$coef[2,1]*a + summary(modII)$coef[3,1]*b})
```

Então inserimos na superficie:


```{r}
p %>%
  add_surface(x = ~range_x, y = ~range_y, z = ~planofator, showscale = FALSE)
```

Ficou estranho....vamos criar a dummie com a condição sim=0 e não=1 ou simplesmente quali. Lembrando da condição que *"partindo de uma amostra de 15 casas, nas quais as casas de números 1, 4, 6, 7, 8, 10 e 12 são em estilo colonial (...)"*


```{r}

oleo<-oleo%>%
mutate(dummie=ifelse(estilo==1,"Sim",
                     ifelse(estilo==4,"Sim",
                     ifelse(estilo==6,"Sim",
                     ifelse(estilo==7,"Sim",
                     ifelse(estilo==8,"Sim",
                     ifelse(estilo==10,"Sim",
                     ifelse(estilo==12,"Sim","Nao"))))))))

str(oleo)

oleo$dummie

```

Refazemos a regressão 

```{r}
modIII<-lm(consumooleo ~ temperatura + qtdisolamento + dummie, data = oleo)
summary(modIII)$coef
```

Vamos inserir no gráfico

```{r}
p <- plot_ly(data = oleo, z = ~consumooleo, x = ~qtdisolamento, y = ~temperatura, opacity = 0.6) %>%
  add_markers(color = ~dummie) 
p
```


```{r message=FALSE}

fig <- plot_ly(z = ~plano0)
fig <- fig %>% add_surface()

fig
```



&nbsp;

***


##### **Referências**

OZON, R. H. **Introdução à Econometria com Excel**, Curso interativo disponibilizado em Udemy.com, nov./2020.
